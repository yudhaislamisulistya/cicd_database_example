name: Database CI/CD (MySQL Dev to Prod)

on:
  push:
    branches:
      - main # Workflow akan dipicu ketika ada perubahan pada branch main
  workflow_dispatch: # Memungkinkan untuk menjalankan secara manual jika dibutuhkan

jobs:
  db_cicd:
    name: Export Dev DB and Import to Prod
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Connect to Server and Run CI/CD
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "ðŸ§ª Menjalankan docker compose..."
            cd /home/yis  # Pindah ke direktori /home/yis
            docker compose up -d  # Jalankan docker compose tanpa opsi -f

            # -------------------- CI (Continuous Integration) --------------------
            echo "â³ Menunggu MySQL Dev siap..."
            sleep 30  # Menunggu MySQL siap, sesuaikan durasi sesuai kecepatan container Anda

            echo "ðŸ§ª Mengecek koneksi ke mysql_devel..."
            # CI: Memeriksa koneksi dan memastikan database di lingkungan pengembangan siap
            docker exec mysql_devel_container mysql -uroot -pTelkom123! -e "SHOW DATABASES;"

            # -------------------- CD (Continuous Deployment) --------------------
            echo "ðŸ“¦ Dump database dari mysql_devel..."
            # CD: Dump database dari mysql_devel untuk dipindahkan ke produksi
            docker exec mysql_devel_container sh -c "mysqldump -uroot -pTelkom123! academics_devel" > dump.sql

            echo "ðŸš› Copy dump ke mysql_prod..."
            # CD: Menyalin dump database ke container produksi
            docker cp dump.sql mysql_prod_container:/tmp/dump.sql

            echo "ðŸ’¾ Import ke mysql_prod..."
            # CD: Mengimpor dump database ke container produksi
            docker exec mysql_prod_container sh -c "mysql -uroot -pTelkom123! academics < /tmp/dump.sql"

            echo "âœ… CI/CD Database selesai"
